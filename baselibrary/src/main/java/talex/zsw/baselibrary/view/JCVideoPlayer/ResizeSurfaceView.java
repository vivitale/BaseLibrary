package talex.zsw.baselibrary.view.JCVideoPlayer;

import android.content.Context;
import android.graphics.PixelFormat;
import android.util.AttributeSet;
import android.view.SurfaceView;

/**
 * <p>参照Android系统的VideoView的onMeasure方法
 * <br>注意!relativelayout中无法全屏，要嵌套一个linearlayout</p>
 * <p>Referring Android system Video View of onMeasure method
 * <br>NOTE! Can not fullscreen relativelayout, to nest a linearlayout</p>
 * <p/>
 * Created by Nathen
 * On 2015/12/08 10:58
 */
class ResizeSurfaceView extends SurfaceView
{
	public ResizeSurfaceView(Context context, AttributeSet attrs)
	{
		super( context, attrs );
		getHolder().setFormat( PixelFormat.TRANSPARENT );
	}

	@Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec)
	{
		//Log.i("@@@@", "onMeasure(" + MeasureSpec.toString(widthMeasureSpec) + ", "
		//        + MeasureSpec.toString(heightMeasureSpec) + ")");
		int mVideoWidth = JCMediaManager.intance().currentVideoWidth;
		int mVideoHeight = JCMediaManager.intance().currentVideoHeight;

		int width = getDefaultSize( mVideoWidth, widthMeasureSpec );
		int height = getDefaultSize( mVideoHeight, heightMeasureSpec );
		if(mVideoWidth > 0 && mVideoHeight > 0)
		{

			int widthSpecMode = MeasureSpec.getMode( widthMeasureSpec );
			int widthSpecSize = MeasureSpec.getSize( widthMeasureSpec );
			int heightSpecMode = MeasureSpec.getMode( heightMeasureSpec );
			int heightSpecSize = MeasureSpec.getSize( heightMeasureSpec );

			if(widthSpecMode == MeasureSpec.EXACTLY && heightSpecMode == MeasureSpec.EXACTLY)
			{
				// the size is fixed
				width = widthSpecSize;
				height = heightSpecSize;

				// for compatibility, we adjust size based on aspect ratio
				if(mVideoWidth * height < width * mVideoHeight)
				{
					//Log.i("@@@", "image too wide, correcting");
					width = height * mVideoWidth / mVideoHeight;
				}
				else if(mVideoWidth * height > width * mVideoHeight)
				{
					//Log.i("@@@", "image too tall, correcting");
					height = width * mVideoHeight / mVideoWidth;
				}
			}
			else if(widthSpecMode == MeasureSpec.EXACTLY)
			{
				// only the width is fixed, adjust the height to match aspect ratio if possible
				width = widthSpecSize;
				height = width * mVideoHeight / mVideoWidth;
				if(heightSpecMode == MeasureSpec.AT_MOST && height > heightSpecSize)
				{
					// couldn't match aspect ratio within the constraints
					height = heightSpecSize;
				}
			}
			else if(heightSpecMode == MeasureSpec.EXACTLY)
			{
				// only the height is fixed, adjust the width to match aspect ratio if possible
				height = heightSpecSize;
				width = height * mVideoWidth / mVideoHeight;
				if(widthSpecMode == MeasureSpec.AT_MOST && width > widthSpecSize)
				{
					// couldn't match aspect ratio within the constraints
					width = widthSpecSize;
				}
			}
			else
			{
				// neither the width nor the height are fixed, try to use actual video size
				width = mVideoWidth;
				height = mVideoHeight;
				if(heightSpecMode == MeasureSpec.AT_MOST && height > heightSpecSize)
				{
					// too tall, decrease both width and height
					height = heightSpecSize;
					width = height * mVideoWidth / mVideoHeight;
				}
				if(widthSpecMode == MeasureSpec.AT_MOST && width > widthSpecSize)
				{
					// too wide, decrease both width and height
					width = widthSpecSize;
					height = width * mVideoHeight / mVideoWidth;
				}
			}
		}
		else
		{
			// no size yet, just adopt the given spec sizes
		}
		setMeasuredDimension( width, height );
	}
}
